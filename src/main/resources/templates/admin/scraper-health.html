<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Scraper Health Dashboard - Resume Optimizer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); margin-bottom: 1.5rem; }
        .card-header { background-color: #fff; border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 600; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-unknown { background-color: #6c757d; }
        .refresh-btn { cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">Resume Optimizer Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/admin/scraper-health">Scraper Health</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-robot me-2"></i>Scraper Health Dashboard</h2>
            <button id="refreshAllBtn" class="btn btn-primary" onclick="refreshAllScrapers()">
                <i class="fas fa-sync-alt me-2"></i>Refresh All Scrapers
            </button>
        </div>

        <div class="row" id="healthCards">
            <!-- Health cards will be populated here by JavaScript -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading scraper status...</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-list me-2"></i>Recent Activity Log
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Portal</th>
                                <th>Status</th>
                                <th>Jobs Found</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="activityLogBody">
                            <!-- Activity logs will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchHealthStatus();
            // Auto-refresh every 30 seconds
            setInterval(fetchHealthStatus, 30000);
        });

        function fetchHealthStatus() {
            fetch('/api/scraper/health')
                .then(response => response.json())
                .then(data => {
                    renderHealthCards(data);
                    renderActivityLog(data);
                })
                .catch(error => console.error('Error fetching health status:', error));
        }

        function renderHealthCards(data) {
            const container = document.getElementById('healthCards');
            container.innerHTML = '';

            // If data is an object with portal names as keys
            Object.keys(data).forEach(portalName => {
                const status = data[portalName];
                const statusClass = getStatusClass(status.status);
                const statusIcon = getStatusIcon(status.status);
                
                const cardHtml = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>${portalName}</span>
                                <span class="badge ${statusClass}">${status.status}</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">Last Success:</small><br>
                                    <strong>${formatDate(status.lastSuccess)}</strong>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Jobs Found:</small><br>
                                    <strong>${status.lastJobCount || 0}</strong>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Success Rate:</small><br>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar ${statusClass}" role="progressbar" 
                                             style="width: ${status.successRate || 0}%" 
                                             aria-valuenow="${status.successRate || 0}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-end d-block">${status.successRate || 0}%</small>
                                </div>
                                ${status.lastError ? `
                                <div class="alert alert-danger py-1 px-2 mb-0" style="font-size: 0.85rem;">
                                    <i class="fas fa-exclamation-circle me-1"></i> ${truncate(status.lastError, 50)}
                                </div>` : ''}
                            </div>
                            <div class="card-footer bg-white border-top-0">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="refreshScraper('${portalName}')">
                                    <i class="fas fa-sync-alt me-1"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        function renderActivityLog(data) {
            // This would ideally come from a separate endpoint for logs
            // For now, we'll just show the current state as a log entry
            // Implementation pending backend support for historical logs
        }

        function getStatusClass(status) {
            if (status === 'HEALTHY' || status === 'ONLINE') return 'bg-success';
            if (status === 'WARNING' || status === 'DEGRADED') return 'bg-warning text-dark';
            if (status === 'ERROR' || status === 'OFFLINE') return 'bg-danger';
            return 'bg-secondary';
        }

        function getStatusIcon(status) {
            if (status === 'HEALTHY' || status === 'ONLINE') return 'fa-check-circle';
            if (status === 'WARNING' || status === 'DEGRADED') return 'fa-exclamation-triangle';
            if (status === 'ERROR' || status === 'OFFLINE') return 'fa-times-circle';
            return 'fa-question-circle';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            return new Date(dateString).toLocaleString();
        }

        function truncate(str, n) {
            return (str && str.length > n) ? str.substr(0, n-1) + '&hellip;' : str;
        }

        function refreshAllScrapers() {
            const btn = document.getElementById('refreshAllBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';

            fetch('/jobs/api/refresh', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('Scraping started for all portals!');
                        setTimeout(fetchHealthStatus, 2000);
                    } else {
                        alert('Failed to start scraping.');
                    }
                })
                .catch(error => console.error('Error:', error))
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        }

        function refreshScraper(portalName) {
            // Pending implementation of single-scraper refresh endpoint
            // For now, trigger global refresh or show alert
            alert('Refreshing ' + portalName + '... (Note: This currently triggers global refresh)');
            refreshAllScrapers();
        }
    </script>
</body>
</html>
